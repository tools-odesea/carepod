<style>
  .cp-testimonials {
    background: {{ section.settings.bg_color }};
    padding: 100px 0;
    overflow: hidden;
  }

  .cp-testimonials__inner {
    max-width: var(--page-width, 1200px);
    margin: 0 auto;
    padding: 0 2rem;
  }

  .cp-testimonials__heading {
    font-family: var(--font-heading-family);
    font-weight: 700;
    font-size: 30px;
    line-height: 1.5;
    text-align: center;
    color: #1c1d1d;
    margin: 0 0 50px;
  }

  /* Carousel viewport */
  .cp-testimonials__viewport {
    position: relative;
    overflow: hidden;
    cursor: grab;
    -webkit-user-select: none;
    user-select: none;
  }

  .cp-testimonials__viewport.is-dragging {
    cursor: grabbing;
  }

  /* Slide track */
  .cp-testimonials__track {
    display: flex;
    transition: transform 0.5s ease;
    will-change: transform;
  }

  .cp-testimonials__viewport.is-dragging .cp-testimonials__track {
    transition: none;
  }

  /* Each slide */
  .cp-testimonials__slide {
    flex: 0 0 33.333%;
    padding: 40px 0 55px;
    box-sizing: border-box;
  }

  /* Card inside slide — this gets the 3D scaling */
  .cp-testimonials__card {
    background: #ffffff;
    padding: 30px;
    margin: 0 12px;
    display: flex;
    flex-direction: column;
    text-align: center;
    transform: scale(0.92);
    transition: transform 0.5s ease, box-shadow 0.5s ease;
    transform-origin: center center;
  }

  .cp-testimonials__slide.is-selected .cp-testimonials__card {
    transform: scale(1.08);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 10;
  }

  .cp-testimonials__stars {
    display: block;
    font-size: 18px;
    letter-spacing: 0.2em;
    margin-bottom: 15px;
    color: #1c1d1d;
  }

  .cp-testimonials__quote {
    font-family: var(--font-body-family);
    font-size: 16px;
    font-weight: 400;
    line-height: 1.6;
    color: #1c1d1d;
    margin: 0 0 30px;
    flex: 1;
  }

  .cp-testimonials__meta {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin-top: auto;
  }

  .cp-testimonials__avatar {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    object-fit: cover;
  }

  .cp-testimonials__name {
    font-family: var(--font-heading-family);
    font-weight: 700;
    font-size: 17px;
    line-height: 1.5;
    color: #1c1d1d;
    margin: 0;
  }

  .cp-testimonials__title {
    font-family: var(--font-body-family);
    font-size: 16px;
    font-weight: 400;
    color: #1c1d1d;
    margin: 0;
  }

  /* Dot navigation */
  .cp-testimonials__dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 0;
    padding: 0;
    list-style: none;
  }

  .cp-testimonials__dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    border: 2px solid currentColor;
    background: transparent;
    padding: 0;
    cursor: pointer;
    transition: background 0.2s;
    color: #1c1d1d;
  }

  .cp-testimonials__dot.is-active {
    background: currentColor;
  }

  /* Tablet: 2 visible */
  @media screen and (max-width: 1024px) {
    .cp-testimonials__slide {
      flex: 0 0 50%;
    }

    .cp-testimonials__card {
      transform: scale(0.78);
    }

    .cp-testimonials__slide.is-selected .cp-testimonials__card {
      transform: scale(1);
    }
  }

  /* Mobile: 1 visible */
  @media screen and (max-width: 749px) {
    .cp-testimonials {
      padding: 50px 0;
    }

    .cp-testimonials__heading {
      font-size: 25px;
      margin-bottom: 20px;
    }

    .cp-testimonials__slide {
      flex: 0 0 100%;
      padding: 20px 0 40px;
    }

    .cp-testimonials__card {
      transform: scale(0.86);
      margin: 0 30px;
      padding: 24px 20px;
    }

    .cp-testimonials__slide.is-selected .cp-testimonials__card {
      transform: scale(1);
    }

    .cp-testimonials__stars {
      font-size: 16px;
    }

    .cp-testimonials__quote {
      font-size: 15px;
    }

    .cp-testimonials__name {
      font-size: 16px;
    }

    .cp-testimonials__title {
      font-size: 15px;
    }

  }
</style>

<div class="cp-testimonials" id="cp-testimonials-{{ section.id }}">
  <div class="cp-testimonials__inner">

    {%- if section.settings.heading != blank -%}
      <h2 class="cp-testimonials__heading">{{ section.settings.heading | escape }}</h2>
    {%- endif -%}

    <div class="cp-testimonials__viewport" id="cp-test-viewport-{{ section.id }}">
      <div class="cp-testimonials__track" id="cp-test-track-{{ section.id }}">
        {%- for block in section.blocks -%}
          <div class="cp-testimonials__slide" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
            <div class="cp-testimonials__card">
              <span class="cp-testimonials__stars" aria-hidden="true">&#9733;&#9733;&#9733;&#9733;&#9733;</span>
              <p class="cp-testimonials__quote">&ldquo;{{ block.settings.quote | escape }}&rdquo;</p>
              <div class="cp-testimonials__meta">
                {%- if block.settings.avatar != blank -%}
                  {%- assign avatar_alt = block.settings.name | escape -%}
                  {{
                    block.settings.avatar
                    | image_url: width: 200
                    | image_tag:
                      class: 'cp-testimonials__avatar',
                      widths: '65, 130, 200',
                      sizes: '65px',
                      loading: 'lazy',
                      alt: avatar_alt
                  }}
                {%- endif -%}
                {%- if block.settings.name != blank -%}
                  <p class="cp-testimonials__name">{{ block.settings.name | escape }}</p>
                {%- endif -%}
                {%- if block.settings.title != blank -%}
                  <p class="cp-testimonials__title">{{ block.settings.title | escape }}</p>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>

    <div class="cp-testimonials__dots" id="cp-test-dots-{{ section.id }}" aria-hidden="true">
      {%- for block in section.blocks -%}
        <button
          class="cp-testimonials__dot{% if forloop.index0 == 1 %} is-active{% endif %}"
          data-index="{{ forloop.index0 }}"
          aria-label="Go to testimonial {{ forloop.index }}"
        ></button>
      {%- endfor -%}
    </div>

  </div>
</div>

<script>
  (function () {
    var sectionId = '{{ section.id }}';
    var viewport = document.getElementById('cp-test-viewport-' + sectionId);
    var track = document.getElementById('cp-test-track-' + sectionId);
    var dots = document.querySelectorAll('#cp-test-dots-' + sectionId + ' .cp-testimonials__dot');
    if (!viewport || !track) return;

    var originalSlides = Array.from(track.querySelectorAll('.cp-testimonials__slide'));
    var total = originalSlides.length;
    if (total === 0) return;

    var current = 0;
    var isDragging = false;
    var startX = 0;
    var dragOffset = 0;
    var isTransitioning = false;

    /* --- Infinite loop: clone slides before and after --- */
    var clonesBefore = [];
    var clonesAfter = [];

    function buildClones() {
      /* Remove old clones */
      clonesBefore.forEach(function (c) { c.remove(); });
      clonesAfter.forEach(function (c) { c.remove(); });
      clonesBefore = [];
      clonesAfter = [];

      var perView = getSlidesPerView();
      /* Clone enough slides to fill the sides */
      var cloneCount = perView;

      for (var i = 0; i < cloneCount; i++) {
        /* Clone last N slides → prepend */
        var beforeIdx = (total - 1 - i + total) % total;
        var cloneBefore = originalSlides[beforeIdx].cloneNode(true);
        cloneBefore.classList.add('is-clone');
        cloneBefore.removeAttribute('data-index');
        track.insertBefore(cloneBefore, track.firstChild);
        clonesBefore.unshift(cloneBefore);

        /* Clone first N slides → append */
        var afterIdx = i % total;
        var cloneAfter = originalSlides[afterIdx].cloneNode(true);
        cloneAfter.classList.add('is-clone');
        cloneAfter.removeAttribute('data-index');
        track.appendChild(cloneAfter);
        clonesAfter.push(cloneAfter);
      }
    }

    function getSlidesPerView() {
      var w = window.innerWidth;
      if (w <= 749) return 1;
      if (w <= 1024) return 2;
      return 3;
    }

    function getSlideWidth() {
      return viewport.offsetWidth / getSlidesPerView();
    }

    function getAllSlides() {
      return Array.from(track.querySelectorAll('.cp-testimonials__slide'));
    }

    function getOffset(index) {
      var perView = getSlidesPerView();
      /* The real slides start after clonesBefore.length clones */
      var realStart = clonesBefore.length;
      /* Position: put the selected slide in the center of the viewport */
      var slidePos = realStart + index;
      var centerOffset = (perView - 1) / 2;
      return (slidePos - centerOffset) * getSlideWidth();
    }

    function goTo(index, animate) {
      if (animate === undefined) animate = true;

      /* Normalize index to [0, total) */
      current = ((index % total) + total) % total;

      var offset = getOffset(current);

      track.style.transition = animate ? 'transform 0.5s ease' : 'none';
      track.style.transform = 'translateX(' + (-offset) + 'px)';

      /* Update selected class on ALL slides (originals + clones) */
      getAllSlides().forEach(function (s) {
        var idx = s.getAttribute('data-index');
        s.classList.toggle('is-selected', idx !== null && parseInt(idx, 10) === current);
      });
      /* Also highlight clone that matches current */
      clonesBefore.concat(clonesAfter).forEach(function (c) {
        c.classList.remove('is-selected');
      });
      /* Find clones that represent the current real index and select neighbors */
      var allSlides = getAllSlides();
      var perView = getSlidesPerView();
      var realStart = clonesBefore.length;
      var centerPos = realStart + current;
      /* Mark the center slide as selected */
      allSlides.forEach(function (s, i) {
        s.classList.toggle('is-selected', i === centerPos);
      });

      /* Update dots */
      dots.forEach(function (d, i) {
        d.classList.toggle('is-active', i === current);
      });
    }

    function slideToDirection(dir) {
      isTransitioning = true;
      var targetIndex = current + dir;
      var normalizedTarget = ((targetIndex % total) + total) % total;

      /* Calculate the offset using the unwrapped target position to animate smoothly */
      var perView = getSlidesPerView();
      var realStart = clonesBefore.length;
      var slidePos = realStart + targetIndex; /* may be -1 or total, that's fine — clones are there */
      var centerOffset = (perView - 1) / 2;
      var offset = (slidePos - centerOffset) * getSlideWidth();

      track.style.transition = 'transform 0.5s ease';
      track.style.transform = 'translateX(' + (-offset) + 'px)';

      /* Update selected visual on the fly */
      var allSlides = getAllSlides();
      allSlides.forEach(function (s, i) {
        s.classList.toggle('is-selected', i === slidePos);
      });

      current = normalizedTarget;

      /* Update dots */
      dots.forEach(function (d, i) {
        d.classList.toggle('is-active', i === current);
      });
    }

    /* After transition ends, silently snap to the real position if we animated to a clone */
    track.addEventListener('transitionend', function () {
      isTransitioning = false;
      /* Snap to correct position without animation */
      var offset = getOffset(current);
      track.style.transition = 'none';
      track.style.transform = 'translateX(' + (-offset) + 'px)';

      /* Fix selected class */
      var allSlides = getAllSlides();
      var realStart = clonesBefore.length;
      var centerPos = realStart + current;
      allSlides.forEach(function (s, i) {
        s.classList.toggle('is-selected', i === centerPos);
      });
    });

    /* Dot click */
    dots.forEach(function (dot) {
      dot.addEventListener('click', function () {
        if (isTransitioning) return;
        var target = parseInt(this.dataset.index, 10);
        goTo(target);
      });
    });

    /* Drag / swipe support */
    viewport.addEventListener('pointerdown', function (e) {
      if (isTransitioning) return;
      isDragging = true;
      startX = e.clientX;
      dragOffset = 0;
      viewport.classList.add('is-dragging');
      viewport.setPointerCapture(e.pointerId);
    });

    viewport.addEventListener('pointermove', function (e) {
      if (!isDragging) return;
      dragOffset = e.clientX - startX;

      var baseOffset = getOffset(current);
      track.style.transition = 'none';
      track.style.transform = 'translateX(' + (-baseOffset + dragOffset) + 'px)';
    });

    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      viewport.classList.remove('is-dragging');

      var threshold = getSlideWidth() * 0.2;
      if (dragOffset < -threshold) {
        slideToDirection(1);
      } else if (dragOffset > threshold) {
        slideToDirection(-1);
      } else {
        goTo(current);
      }
    }

    viewport.addEventListener('pointerup', endDrag);
    viewport.addEventListener('pointercancel', endDrag);

    /* Prevent text selection while dragging */
    viewport.addEventListener('dragstart', function (e) { e.preventDefault(); });

    /* Resize handler */
    var resizeTimer;
    window.addEventListener('resize', function () {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function () {
        buildClones();
        goTo(current, false);
      }, 100);
    });

    /* Auto-play timer */
    var autoplayInterval = 4000;
    var autoplayTimer = null;

    function startAutoplay() {
      stopAutoplay();
      autoplayTimer = setInterval(function () {
        if (!isTransitioning && !isDragging) {
          slideToDirection(1);
        }
      }, autoplayInterval);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    /* Pause autoplay when user hovers over the carousel */
    viewport.addEventListener('mouseenter', stopAutoplay);
    viewport.addEventListener('mouseleave', startAutoplay);

    /* Initialize */
    buildClones();
    goTo(current, false);
    startAutoplay();
  })();
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Loved by Professionals"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f9f9f9"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Photo"
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "I finally found a humidifier that is effective yet mold-resistant and easy to clean."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Dr. Tim Tiutan"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Professional title",
          "default": "Internal Medicine"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "quote": "I finally found a humidifier that is effective yet mold-resistant and easy to clean. It has easily become a part of my nightly ritual to refill my Carepod. Given the health benefits associated with it, I love it so far!",
            "name": "Dr. Tim Tiutan",
            "title": "Internal Medicine"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "I recently discovered Carepod and absolutely love it. As a pediatric naturopathic doctor, the cold and dry climate we're in makes it a valuable addition. I'm obsessed with everything about it, especially the stainless steel water tank, which is so easy to clean. And the best part? It won't grow mold.",
            "name": "Dr. Elana Roumell",
            "title": "Pediatric Naturopathic"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "How often do we talk about sleep when it comes to kids? All the time. They need good sleep to function. Our old humidifier was hard to clean and always got moldy. When I saw that Carepod only had three pieces that needed cleaning (and was easy!), I immediately knew that this was the one.",
            "name": "Katie Zelinski",
            "title": "Pediatric Occupational Therapist"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Carepod is hands down the best humidifier on the market. It's sleek, fun to use, soothing, and holds a good amount of water so you can benefit from it day or night. I highly recommend it to all my clients for their skin, and overall wellness!",
            "name": "Tess Zolly",
            "title": "Licensed Esthetician"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Once one of my daughters starts coughing, it keeps on going, so we use humidifiers all the time. I love how easy it is to clean our Carepod, with three easy steps. It feels good knowing I'm giving my child the most hydrating air only!",
            "name": "Dr. Jesse L. Berry",
            "title": "Ophthalmology Surgeon"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "I recommend Carepod for anyone thanks to its health benefits, and especially because it's so convenient and easy to clean. As a bonus, I love its modern chic design that blends well into any environment.",
            "name": "Dr. Jiyeh Joo",
            "title": "Family Physician"
          }
        }
      ]
    }
  ]
}
{% endschema %}
